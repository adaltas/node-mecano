// Generated by CoffeeScript 2.5.1
var utils;

utils = require('../../utils');

module.exports = {
  name: '@nikitajs/core/lib/plugins/metadata/position',
  require: ['@nikitajs/core/lib/plugins/history'],
  hooks: {
    'nikita:normalize': {
      after: '@nikitajs/core/lib/plugins/history',
      handler: function(action, handler) {
        return async function() {
          action = (await handler.call(null, ...arguments));
          action.metadata.depth = action.parent ? action.parent.metadata.depth + 1 : 0;
          // plugins are not activated in the root session with {depth: 0}
          action.metadata.index = action.siblings ? action.siblings.length : 0;
          action.metadata.position = action.parent ? action.parent.metadata.position.concat([action.metadata.index]) : [0];
          return action;
        };
      }
    },
    'nikita:action': function(action) {
      if (typeof action.metadata.depth !== 'number') {
        throw utils.error('METADATA_DEPTH_INVALID_VALUE', ["configuration `depth` expect an integer value,", `got ${JSON.stringify(action.metadata.depth)}.`]);
      }
    }
  }
};

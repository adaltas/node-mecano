// Generated by CoffeeScript 2.5.1
  // # `nikita.tools.npm`

// Install Node.js packages with NPM.

// It upgrades outdated packages if config "upgrade" is "true".

// ## Example

// The following action installs the coffescript package globally.

// ```js
  // const {status} = await nikita.tools.npm({
  //   name: 'coffeescript',
  //   global: true
  // })
  // console.info(`Package was installed: ${status}`)
  // ```

// ## Hooks
var handler, on_action, schema,
  indexOf = [].indexOf;

on_action = function({config, metadata}) {
  if (typeof metadata.argument === 'string') {
    config.name = metadata.argument;
  }
  if (typeof config.name === 'string') {
    return config.name = [config.name];
  }
};

// ## Schema
schema = {
  type: 'object',
  properties: {
    'cwd': {
      $ref: 'module://@nikitajs/engine/src/actions/execute#/properties/cwd'
    },
    'global': {
      type: 'boolean',
      default: false,
      description: `Installs the current package context as a global package.`
    },
    'name': {
      type: 'array',
      items: {
        type: 'string'
      },
      description: `Name of the package(s) to install or upgrade if config "upgrade" is
"true".`
    },
    'sudo': {
      $ref: 'module://@nikitajs/engine/src/actions/execute#/properties/sudo'
    },
    'upgrade': {
      default: false,
      type: 'boolean',
      description: `Upgrade outdated packages.`
    }
  },
  required: ['name'],
  if: {
    properties: {
      'global': {
        const: false
      }
    }
  },
  then: {
    required: ['cwd']
  }
};

// ## Handler
handler = async function({
    config,
    tools: {log}
  }) {
  var global, install, installed, outdated, pkgs, stdout, upgrade;
  global = config.global ? '-g' : '';
  // Get outdated packages
  outdated = [];
  ({stdout} = (await this.execute({
    command: `npm outdated --json ${global}`,
    code: [0, 1],
    cwd: config.cwd,
    stdout_log: false,
    metadata: {
      shy: true
    }
  })));
  pkgs = JSON.parse(stdout);
  if (Object.keys(pkgs).length) {
    outdated = Object.keys(pkgs);
  }
  // Upgrade outdated packages
  upgrade = config.name.filter(function(pkg) {
    return indexOf.call(outdated, pkg) >= 0;
  });
  if (config.upgrade && upgrade.length) {
    await this.execute({
      command: `npm update ${global} ${upgrade.join(' ')}`,
      cwd: config.cwd,
      sudo: config.sudo
    });
    log({
      message: `NPM Updated Packages: ${upgrade.join(', ')}`
    });
  }
  // Get installed packages
  installed = [];
  ({stdout} = (await this.execute({
    command: `npm list --json ${global}`,
    code: [0, 1],
    cwd: config.cwd,
    stdout_log: false,
    metadata: {
      shy: true
    }
  })));
  pkgs = JSON.parse(stdout);
  if (Object.keys(pkgs).length) {
    installed = Object.keys(pkgs.dependencies);
  }
  // Install packages
  install = config.name.filter(function(pkg) {
    return indexOf.call(installed, pkg) < 0;
  });
  if (!install.length) {
    return;
  }
  await this.execute({
    command: `npm install ${global} ${install.join(' ')}`,
    cwd: config.cwd,
    sudo: config.sudo
  });
  return log({
    message: `NPM Installed Packages: ${install.join(', ')}`
  });
};

// ## Export
module.exports = {
  handler: handler,
  hooks: {
    on_action: on_action
  },
  metadata: {
    schema: schema
  }
};

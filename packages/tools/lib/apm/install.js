// Generated by CoffeeScript 2.5.1
  // # `nikita.tools.apm`

// Install Atom packages with APM.

// ## Options

// *   `name` (string|array)
  //     Name of the package(s).
  // *   `upgrade` (boolean)
  //     Upgrade all packages, default to "false".

// ## Schema
var handler, schema, string,
  indexOf = [].indexOf;

schema = {
  type: 'object',
  properties: {
    '': {
      type: 'object',
      description: `          `
    }
  }
};

// ## Handler
handler = function({config}) {
  var installed, outdated;
  if (config.argument != null) {
    config.name = config.argument;
  }
  if (typeof config.name === 'string') {
    config.name = [config.name];
  }
  config.name = config.name.map(function(pkg) {
    return pkg.toLowerCase();
  });
  outdated = [];
  installed = [];
  // Note, cant see a difference between update and upgrade after printing help
  this.execute({
    cmd: "apm outdated --json",
    shy: true
  }, function(err, {stdout}) {
    var pkgs;
    if (err) {
      throw err;
    }
    pkgs = JSON.parse(stdout);
    return outdated = pkgs.map(function(pkg) {
      return pkg.name.toLowerCase();
    });
  });
  this.execute({
    cmd: "apm upgrade --no-confirm",
    if: function() {
      return config.upgrade && outdated.length;
    }
  }, function(err) {
    if (err) {
      throw err;
    }
    return outdated = [];
  });
  this.execute({
    cmd: "apm list --installed --json",
    shy: true
  }, function(err, {stdout}) {
    var pkgs;
    if (err) {
      throw err;
    }
    pkgs = JSON.parse(stdout);
    pkgs = pkgs.user.map(function(pkg) {
      return pkg.name.toLowerCase();
    });
    return installed = pkgs;
  });
  return this.call(function() {
    var install, upgrade;
    upgrade = config.name.filter(function(pkg) {
      return indexOf.call(outdated, pkg) >= 0;
    });
    install = config.name.filter(function(pkg) {
      return indexOf.call(installed, pkg) < 0;
    });
    this.execute({
      cmd: `apm upgrade ${upgrade.join(' ')}`,
      if: upgrade.length
    }, (err) => {
      return this.log({
        message: `APM Updated Packages: ${upgrade.join(', ')}`
      });
    });
    return this.execute({
      cmd: `apm install ${install.join(' ')}`,
      if: install.length
    }, (err) => {
      return this.log({
        message: `APM Installed Packages: ${install.join(', ')}`
      });
    });
  });
};

// ## Exports
module.exports = {
  handler: handler,
  schema: schema
};

// ## Dependencies
string = require('@nikitajs/core/lib/misc/string');

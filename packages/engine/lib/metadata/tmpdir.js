// Generated by CoffeeScript 2.5.1
// {is_object, is_object_literal} = require 'mixme'
var exec, fs, os, path, process, utils;

utils = require('../utils');

os = require('os');

path = require('path');

process = require('process');

fs = require('ssh2-fs');

exec = require('ssh2-exec');

module.exports = function() {
  return {
    module: '@nikitajs/engine/src/metadata/status',
    require: ['@nikitajs/engine/src/plugins/tools_find', '@nikitajs/engine/src/plugins/tools_path'],
    hooks: {
      'nikita:session:action': {
        after: ['@nikitajs/engine/src/plugins/ssh', '@nikitajs/engine/src/metadata/uuid'],
        handler: async function(action) {
          var err, ref, rootdir, ssh, tmpdir;
          if ((ref = typeof action.metadata.tmpdir) !== 'boolean' && ref !== 'string' && ref !== 'undefined') {
            throw utils.error('METADATA_TMPDIR_INVALID', ['the "tmpdir" metadata value must be a boolean or a string,', `got ${JSON.stringify(action.metadata.tmpdir)}`]);
          }
          if (!action.metadata.tmpdir) {
            return;
          }
          // SSH connection extraction
          ssh = action.config.ssh === false ? void 0 : (await action.tools.find(function(action) {
            return action.ssh;
          }));
          // tmpdir = if ssh then '/tmp' else os.tmpdir()
          // Generate temporary location
          rootdir = ssh ? '/tmp' : os.tmpdir();
          tmpdir = (function() {
            switch (typeof action.metadata.tmpdir) {
              case 'string':
                return action.metadata.tmpdir;
              case 'boolean':
                return 'nikita-' + action.metadata.uuid;
            }
          })();
          action.metadata.tmpdir = path.resolve(rootdir, tmpdir);
          try {
            // Temporary directory creation
            await fs.mkdir(ssh, action.metadata.tmpdir);
            return action.metadata.tmpdir_dispose = true;
          } catch (error) {
            err = error;
            if (err.code !== 'EEXIST') {
              throw err;
            }
          }
        }
      },
      'nikita:session:result': {
        before: '@nikitajs/engine/src/plugins/ssh',
        handler: async function({action}) {
          var ssh, tmpdir;
          // Value of tmpdir could still be true if there was an error in
          // one of the on_action hook, such as a invalid schema validation
          if (typeof action.metadata.tmpdir !== 'string') {
            return;
          }
          if (!action.metadata.tmpdir_dispose) {
            return;
          }
          if (action.metadata.dirty) {
            return;
          }
          // SSH connection extraction
          ssh = action.config.ssh === false ? void 0 : (await action.tools.find(function(action) {
            // action.state['nikita:ssh:connection']
            return action.ssh;
          }));
          // Ensure the location is correct
          tmpdir = ssh ? '/tmp' : os.tmpdir();
          if (!action.metadata.tmpdir.startsWith(tmpdir)) {
            throw utils.error('METADATA_TMPDIR_CORRUPTION', ['the "tmpdir" metadata value does not start as expected,', `got ${JSON.stringify(action.metadata.tmpdir)},`, `expected to start with ${JSON.stringify(tmpdir)}`]);
          }
          // Temporary directory decommissioning
          return (await new Promise(function(resolve, reject) {
            return exec(ssh, `rm -r '${action.metadata.tmpdir}'`, function(err) {
              if (err) {
                return reject(err);
              } else {
                return resolve();
              }
            });
          }));
        }
      }
    }
  };
};

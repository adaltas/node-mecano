// Generated by CoffeeScript 2.3.1
// # `nikita.service.install(options, [callback])`

// Install a service. Yum, Yaourt, Pacman and apt-get are supported.

// ## Options

// * `arch_chroot` (boolean|string)   
//   Run this command inside a root directory with the arc-chroot command or any
//   provided string, require the "rootdir" option if activated.
// * `cache` (boolean)   
//   Cache the list of installed and outpdated packages.
// * `cacheonly` (boolean)   
//   Run the yum command entirely from system cache, don't update cache.
// * `code_skipped` (integer|array)   
//    Error code to skip when using nikita.service.
// * `installed`   
//   Cache a list of installed services. If an object, the service will be
//   installed if a key of the same name exists; if anything else (default), no
//   caching will take place.
// * `name` (string)   
//   Package name, required unless provided as main argument.
// * `outdated`   
//   Cache a list of outdated services. If an object, the service will be updated
//   if a key of the same name exists; If true, the option will be converted to
//   an object with all the outdated service names as keys; if anything else
//   (default), no caching will take place.
// * `rootdir` (string)   
//   Path to the mount point corresponding to the root directory, required if
//   the "arch_chroot" option is activated.

// ## Callback parameters

// * `err`   
//   Error object if any.   
// * `status`   
//   Indicates if the service was installed.   

// ## Example

// ```js
// require('nikita').service.install({
//   ssh: ssh,
//   name: 'ntp'
// }, function(err, status){
//   console.log(err || "Package installed: " + status ? 'yes' : 'no');
// });
// ```

// ## Source Code
var string;

module.exports = function(options) {
  var cacheonly;
  this.log({
    message: "Entering service.install",
    level: 'DEBUG',
    module: 'nikita/lib/service/install'
  });
  if (typeof options.argument === 'string') {
    // Options
    if (options.name == null) {
      options.name = options.argument;
    }
  }
  if (options.cache) {
    if (options.installed == null) {
      options.installed = this.store['nikita:execute:installed'];
    }
  }
  if (options.cache) {
    if (options.outpdated == null) {
      options.outpdated = this.store['nikita:execute:outpdated'];
    }
  }
  cacheonly = options.cacheonly ? '-C' : '';
  if (!options.name) {
    // Validation
    throw Error(`Invalid Name: ${JSON.stringify(options.name)}`);
  }
  // Start real work
  this.log({
    message: `Install service ${options.name}`,
    level: 'INFO',
    module: 'nikita/lib/service/install'
  });
  // List installed packages
  this.system.execute({
    unless: options.installed != null,
    cmd: "if command -v yum >/dev/null 2>&1; then\n  rpm -qa --qf \"%{NAME}\n\"\nelif command -v pacman >/dev/null 2>&1; then\n  pacman -Qqe\nelif command -v apt-get >/dev/null 2>&1; then\n  dpkg -l | grep \'^ii\' | awk \'{print $2}\'\nelse\n  echo \"Unsupported Package Manager\" >&2\n  exit 2\nfi",
    code_skipped: 1,
    arch_chroot: options.arch_chroot,
    rootdir: options.rootdir,
    stdin_log: false,
    stdout_log: false,
    shy: true
  }, function(err, {status, stdout}) {
    var pkg;
    if ((err != null ? err.code : void 0) === 2) {
      throw Error("Unsupported Package Manager");
    }
    if (err) {
      throw err;
    }
    if (!status) {
      return;
    }
    this.log({
      message: "Installed packages retrieved",
      level: 'INFO',
      module: 'nikita/lib/service/install'
    });
    return options.installed = (function() {
      var i, len, ref, results;
      ref = string.lines(stdout);
      results = [];
      for (i = 0, len = ref.length; i < len; i++) {
        pkg = ref[i];
        results.push(pkg);
      }
      return results;
    })();
  });
  // List packages waiting for update
  this.system.execute({
    unless: options.outpdated != null,
    if: function() {
      return options.installed.indexOf(options.name) === -1;
    },
    cmd: `if command -v yum >/dev/null 2>&1; then\n  yum ${cacheonly} list updates | egrep updates$ | sed 's/\\([^\\.]*\\).*/\\1/'\nelif command -v pacman >/dev/null 2>&1; then\n  pacman -Qu | sed 's/\\([^ ]*\\).*/\\1/'\nelif command -v apt-get >/dev/null 2>&1; then\n  apt-get -u upgrade --assume-no | grep '^\\s' | sed 's/\\s/\\n/g'\nelse\n  echo "Unsupported Package Manager" >&2\n  exit 2\nfi`,
    code_skipped: 1,
    arch_chroot: options.arch_chroot,
    rootdir: options.rootdir,
    stdin_log: false,
    stdout_log: false,
    shy: true
  }, function(err, {status, stdout}) {
    if ((err != null ? err.code : void 0) === 2) {
      throw Error("Unsupported Package Manager");
    }
    if (err) {
      throw err;
    }
    if (!status) {
      return options.outpdated = [];
    }
    this.log({
      message: "Outpdated package list retrieved",
      level: 'INFO',
      module: 'nikita/lib/service/install'
    });
    return options.outpdated = string.lines(stdout.trim());
  });
  this.system.execute({
    if: function() {
      return options.installed.indexOf(options.name) === -1 || options.outpdated.indexOf(options.name) !== -1;
    },
    cmd: `if command -v yum >/dev/null 2>&1; then\n  yum install -y ${cacheonly} ${options.name}\nelif command -v yaourt >/dev/null 2>&1; then\n  yaourt --noconfirm -S ${options.name}\nelif command -v pacman >/dev/null 2>&1; then\n  pacman --noconfirm -S ${options.name}\nelif command -v apt-get >/dev/null 2>&1; then\n  apt-get install -y ${options.name}\nelse\n  echo "Unsupported Package Manager: yum, pacman, apt-get supported" >&2\n  exit 2\nfi`,
    code_skipped: options.code_skipped,
    arch_chroot: options.arch_chroot,
    rootdir: options.rootdir
  }, function(err, {status}) {
    var installedIndex, outpdatedIndex;
    if ((err != null ? err.code : void 0) === 2) {
      throw Error("Unsupported Package Manager: yum, yaourt, pacman, apt-get supported");
    }
    if (err) {
      throw err;
    }
    this.log(status ? {
      message: `Package "${options.name}" is installed`,
      level: 'WARN',
      module: 'nikita/lib/service/install'
    } : {
      message: `Package "${options.name}" is already installed`,
      level: 'INFO',
      module: 'nikita/lib/service/install'
    });
    // Enrich installed array with package name unless already there
    installedIndex = options.installed.indexOf(options.name);
    if (installedIndex === -1) {
      options.installed.push(options.name);
    }
    // Remove package name from outpdated if listed
    if (options.outpdated) {
      outpdatedIndex = options.outpdated.indexOf(options.name);
      if (outpdatedIndex !== -1) {
        return options.outpdated.splice(outpdatedIndex, 1);
      }
    }
  });
  return this.call({
    if: options.cache,
    handler: function() {
      this.log({
        message: "Caching installed on \"nikita:execute:installed\"",
        level: 'INFO',
        module: 'nikita/lib/service/install'
      });
      this.store['nikita:execute:installed'] = options.installed;
      this.log({
        message: "Caching outpdated list on \"nikita:execute:outpdated\"",
        level: 'INFO',
        module: 'nikita/lib/service/install'
      });
      return this.store['nikita:execute:outpdated'] = options.outpdated;
    }
  });
};

// ## Dependencies
string = require('../misc/string');
